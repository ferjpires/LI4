-- Procedure para obter utilizador por ID
CREATE PROCEDURE spUtilizador_GetById
    @Id INT
AS
BEGIN
    SELECT 
        u.*,
        -- Calcular a média de satisfação e o tempo médio por produto
        ISNULL(AVG(CAST(lm.Satisfacao AS DECIMAL(4,2))), 0) AS MediaDeSatisfacaoCalculada,
        ISNULL(CAST(DATEADD(SECOND, AVG(DATEDIFF(SECOND, lm.DataDeInicio, lm.DataDeFim)), 0) AS TIME), '00:00:00') AS TempoMedioPorProdutoCalculado
    FROM Utilizador u
    LEFT JOIN LinhaDeMontagem lm ON lm.IdFuncionario = u.Id
    WHERE u.Id = @Id
    GROUP BY 
        u.Id, u.Nome, u.Senha, u.NIF, u.DataDeNascimento, u.DataDeCriacao,
        u.ImagemURL, u.QuantidadeDeProdutosRealizados, u.QuantidadeDeProdutosRejeitados,
        u.MediaDeSatisfacao, u.TempoMedioPorProduto, u.Tipo;
END;
GO

-- Procedure para obter todos os utilizadores
CREATE PROCEDURE spUtilizador_GetAll
AS
BEGIN
    SELECT 
        u.*,
        -- Calcular a média de satisfação e o tempo médio por produto
        ISNULL(AVG(CAST(lm.Satisfacao AS DECIMAL(4,2))), 0) AS MediaDeSatisfacaoCalculada,
        ISNULL(CAST(DATEADD(SECOND, AVG(DATEDIFF(SECOND, lm.DataDeInicio, lm.DataDeFim)), 0) AS TIME), '00:00:00') AS TempoMedioPorProdutoCalculado
    FROM Utilizador u
    LEFT JOIN LinhaDeMontagem lm ON lm.IdFuncionario = u.Id
    GROUP BY 
        u.Id, u.Nome, u.Senha, u.NIF, u.DataDeNascimento, u.DataDeCriacao,
        u.ImagemURL, u.QuantidadeDeProdutosRealizados, u.QuantidadeDeProdutosRejeitados,
        u.MediaDeSatisfacao, u.TempoMedioPorProduto, u.Tipo;
END;
GO


-- Procedure para inserir um novo utilizador
CREATE PROCEDURE spUtilizador_Insert
    @Nome NVARCHAR(45),
    @Senha NVARCHAR(100),
    @NIF CHAR(9),
    @DataDeNascimento DATETIME2(7),
    @ImagemURL NVARCHAR(90),
    @Tipo NVARCHAR(15)
AS
BEGIN
    INSERT INTO Utilizador (Nome, Senha, NIF, DataDeNascimento, ImagemURL, Tipo)
    VALUES (@Nome, @Senha, @NIF, @DataDeNascimento, @ImagemURL, @Tipo);

    SELECT SCOPE_IDENTITY() AS NovoId;
END;
GO

-- Procedure para atualizar utilizador existente
CREATE PROCEDURE spUtilizador_Update
    @Id INT,
    @Nome NVARCHAR(45),
    @Senha NVARCHAR(100),
    @NIF CHAR(9),
    @DataDeNascimento DATETIME2(7),
    @ImagemURL NVARCHAR(90),
    @QuantidadeDeProdutosRealizados INT,
    @QuantidadeDeProdutosRejeitados INT,
    @MediaDeSatisfacao DECIMAL(4,2),
    @TempoMedioPorProduto TIME,
    @Tipo NVARCHAR(15)
AS
BEGIN
    UPDATE Utilizador
    SET Nome = @Nome,
        Senha = @Senha,
        NIF = @NIF,
        DataDeNascimento = @DataDeNascimento,
        ImagemURL = @ImagemURL,
        QuantidadeDeProdutosRealizados = @QuantidadeDeProdutosRealizados,
        QuantidadeDeProdutosRejeitados = @QuantidadeDeProdutosRejeitados,
        MediaDeSatisfacao = @MediaDeSatisfacao,
        TempoMedioPorProduto = @TempoMedioPorProduto,
        Tipo = @Tipo
    WHERE Id = @Id;
END;
GO

-- Procedure para apagar utilizador
CREATE PROCEDURE spUtilizador_Delete
    @Id INT
AS
BEGIN
    DELETE FROM Utilizador
    WHERE Id = @Id;
END;
GO

-- Procedure para aumentar em 1 as pizzas rejeitadas
CREATE PROCEDURE spUtilizador_IncrementarPizzasRejeitadas
    @Id INT
AS
BEGIN
    -- Atualiza o campo QuantidadeDeProdutosRejeitados incrementando em 1
    UPDATE Utilizador
    SET QuantidadeDeProdutosRejeitados = QuantidadeDeProdutosRejeitados + 1
    WHERE Id = @Id;

    -- Retorna os dados do utilizador atualizado (opcional)
    SELECT *
    FROM Utilizador
    WHERE Id = @Id;
END;
GO
